/**
 * LICENSE_PLACEHOLDER
 **/
import concat from 'lodash/concat'
import reduce from 'lodash/reduce'
import find from 'lodash/find'
import forEach from 'lodash/forEach'
import values from 'lodash/values'
import remove from 'lodash/remove'
import { FixedTableContainer } from '@regardsoss/components'
import {
  AttributeModel,
  AttributeConfiguration,
  AttributesRegroupementConfiguration,
  SearchResultsTargetsEnum,
} from '@regardsoss/model'
import CatalogEntitySelector from '../../models/catalog/CatalogEntitySelector'
import CatalogEntityActions from '../../models/catalog/CatalogEntityActions'
import NavigationComponent from './NavigationComponent'
import ThumbmailCellComponent from './ThumbmailCellComponent'
import DatasetCellComponent from './DatasetCellComponent'

/**
 * Constant to define where to find dynamic attributes in the data objects returned by the search endpoint
 * @type {string}
 */
const DATA_ATTRIBUTES_FIELD = 'properties'
const DEFAULT_FRAGMENT = 'default'
/**
 * React container to manage search requests and display results.
 * Search queries are generated by the FormComponent and used by this container.
 * @author SÃ©bastien binda
 */
class SearchResultsComponent extends React.Component {

  static propTypes = {
    searchQuery: React.PropTypes.string,
    attributesConf: React.PropTypes.arrayOf(AttributeConfiguration),
    attributesRegroupementsConf: React.PropTypes.arrayOf(AttributesRegroupementConfiguration),
    attributeModels: React.PropTypes.objectOf(AttributeModel),
    target: React.PropTypes.oneOf(values(SearchResultsTargetsEnum)).isRequired,
  }

  constructor(props) {
    super(props)
    this.state = {
      sortedColumns: [],
      target: props.target,
      searchQuery: props.searchQuery,
      selectedDataset: null,
    }
  }

  componentWillReceiveProps(nextProps) {
    if (nextProps.searchQuery !== this.state.searchQuery){
      this.setState({
        searchQuery: nextProps.searchQuery
      })
    }
  }

  /**
   * Format the given search query for opensearch format
   * @param query
   * @returns {string}
   */
  formatSearchQuery = query => `q=(${query})`

  /**
   * Create full query by adding sort options, target options
   * @returns {string}
   */
  getFullQuery = () => {
    let fullQuery = this.state.searchQuery ? this.formatSearchQuery(this.state.searchQuery): ''


    if (this.state.sortedColumns.length > 0) {
      const result = reduce(this.state.sortedColumns, (sortQuery, column) => {
        if (column.type === null) {
          return sortQuery
        }
        if (sortQuery.length > 0) {
          return `${sortQuery}&${column.attribute}:${column.type}`
        }
        return `${column.attribute}:${column.type}`
      }, '')
      if (result.length > 0) {
        fullQuery = `${fullQuery}&sort=(${result})`
      }
    }

    fullQuery = `${fullQuery}&target=${this.state.target}`
    return fullQuery
  }

  getFullyQualifiedAttributeName = (attribute) => {
    if (!attribute.content.fragment || !attribute.content.fragment.name ||
      attribute.content.fragment.name === DEFAULT_FRAGMENT) {
      return `${DATA_ATTRIBUTES_FIELD}.${attribute.content.name}`
    }
    return `${DATA_ATTRIBUTES_FIELD}.${attribute.content.fragment.name}.${attribute.content.name}`
  }

  sortResultsByColumn = (column, type) => {
    const attributeToSort = column.attributes[0]
    const sortedColumns = concat([], this.state.sortedColumns)
    const col = find(sortedColumns, lcol => lcol.attribute === attributeToSort)
    if (!col) {
      sortedColumns.push({
        attribute: attributeToSort,
        type,
      })
    } else {
      switch (type) {
        case 'ASC':
          col.type = 'ASC'
          break
        case 'DESC':
          col.type = 'DESC'
          break
        default:
          remove(sortedColumns, lcol => lcol.attribute === attributeToSort)
      }
    }
    this.setState({
      sortedColumns,
    })
  }

  onChangeTarget = (target) => {
    let searchQuery = this.state.searchQuery
    if (target === SearchResultsTargetsEnum.DATASET_RESULTS){
      searchQuery = this.props.searchQuery
    }
    this.setState({
      target,
      searchQuery
    })
  }

  resultSelection = (selectedEntities) => {
    // TODO Manage entities selection
    console.log('Selected entities', selectedEntities)
  }

  getDataObjectsColumns = () => {
    const columns = []

    // TODO Manage standard attributes with search-form configuration
    columns.push({
      label: 'Image',
      attributes: ['files'],
      customCell: { component: ThumbmailCellComponent, props: {} },
      fixed: 40,
      hideLabel: true,
    })
    columns.push({ label: 'Identifier', attributes: ['ip_id'] })
    columns.push({ label: 'Label', attributes: ['label'], sortable: true })

    // Read module configuration to get attributes to display
    forEach(this.props.attributesConf, (attributeConf) => {
      if (attributeConf.visibility === true) {
        const attribute = find(this.props.attributeModels, att => att.content.id === attributeConf.id)
        if (attribute) {
          columns.push({
            label: attribute.content.name,
            attributes: [this.getFullyQualifiedAttributeName(attribute)],
            sortable: true,
          })
        }
      }
    })

    // Read module configuration to get attributes regroupements to display
    forEach(this.props.attributesRegroupementsConf, (attributeConf) => {
      if (attributeConf.visibility === true) {
        const attributes = reduce(attributeConf.attributes, (results, attributeId) => {
          const attribute = find(this.props.attributeModels, att => att.content.id === attributeId)
          if (attribute) {
            results.push(this.getFullyQualifiedAttributeName(attribute))
          }
          return results
        }, [])
        if (attributes && attributes.length > 0) {
          columns.push({
            label: attributeConf.label,
            attributes,
            sortable: false,
          })
        }
      }
    })
    return columns
  }

  getDataSetsColumns = () => {
    const columns = []
    columns.push({
      label: 'Label',
      attributes: ['label','ip_id','properties'],
      sortable: false,
      customCell: { component: DatasetCellComponent, props: {onClick: this.selectDataset} },
      hideLabel:true
    })
    return columns
  }

  /**
   * Callback when a dataset is selected.
   * Add the urn of the dataset in the search query and switch to data objects view
   * @param dataset
   */
  selectDataset = (dataset) => {
    let newSearchQuery = `tags:${dataset.ip_id}`
    if (this.state.searchQuery) {
      newSearchQuery = `${this.state.searchQuery} AND ${newSearchQuery}`
    }
    this.setState({
      searchQuery : newSearchQuery,
      target: SearchResultsTargetsEnum.DATAOBJECT_RESULTS,
      selectedDataset: dataset,
    })
  }

  renderNavigation = () => {
    // If initial target is dataobject, do not display switch target buttons
      return (
        <NavigationComponent
          selectedTarget={this.state.target}
          onChangeTarget={this.onChangeTarget}
          selectedDataset={this.state.selectedDataset}
        />
      )
  }

  render() {
    let columns = []
    let lineSize = 50
    let cellsStyle = null
    switch (this.state.target) {
      case SearchResultsTargetsEnum.DATAOBJECT_RESULTS :
        columns = this.getDataObjectsColumns()
        break
      case SearchResultsTargetsEnum.DATASET_RESULTS :
        columns = this.getDataSetsColumns()
        lineSize = 120
        cellsStyle = {backgroundColor: 'transparent'}
        break
      default :
        console.error(`Undefined target type for entity search results : ${this.state.target}`)
    }

    return (
      <div>
        {this.renderNavigation()}
        <FixedTableContainer
          key={this.state.target}
          PageActions={CatalogEntityActions}
          PageSelector={CatalogEntitySelector}
          pageSize={20}
          lineHeight={lineSize}
          displayCheckbox={this.state.target === SearchResultsTargetsEnum.DATAOBJECT_RESULTS}
          displayHeader={this.state.target === SearchResultsTargetsEnum.DATAOBJECT_RESULTS}
          columns={columns}
          onSelectionChange={this.resultSelection}
          onSortByColumn={this.sortResultsByColumn}
          requestParams={{ queryParams: this.getFullQuery() }}
          cellsStyle={cellsStyle}
        />
      </div>
    )
  }
}

export default SearchResultsComponent
